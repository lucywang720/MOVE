import torch
import gym
import numpy as np
import matplotlib.pyplot as plt
import os
import metaworld
import random
import time
from scipy.stats import truncnorm

from natsort import natsorted
from termcolor import cprint
from gym import spaces
from diffusion_policy_3d.gym_util.mujoco_point_cloud import PointCloudGenerator
from diffusion_policy_3d.gym_util.mjpc_wrapper import point_cloud_sampling

TASK_BOUDNS = {
    'default': [-0.5, -1.5, -0.795, 1, -0.4, 100],
}

obj_x = [0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.047432432432432434, 0.044864864864864865, 0.042297297297297295, 0.039729729729729726, 0.03716216216216216, 0.03459459459459459, 0.03202702702702702, 0.02945945945945945, 0.02689189189189188, 0.024324324324324312, 0.021756756756756743, 0.019189189189189174, 0.016621621621621605, 0.014054054054054037, 0.01148648648648647, 0.008918918918918902, 0.006351351351351335, 0.0037837837837837673, 0.0012162162162161995, -0.0013513513513513683, -0.003918918918918936, -0.0064864864864865035, -0.00905405405405407, -0.011621621621621638, -0.014189189189189206, -0.016756756756756773, -0.019324324324324342, -0.02189189189189191, -0.02445945945945948, -0.02702702702702705, -0.02959459459459462, -0.03216216216216219, -0.03472972972972976, -0.037297297297297326, -0.039864864864864895, -0.042432432432432464, -0.04500000000000003, -0.0475675675675676, -0.05013513513513517, -0.05270270270270274, -0.05527027027027031, -0.05783783783783788, -0.06040540540540545, -0.06297297297297301, -0.06554054054054058, -0.06810810810810815, -0.07067567567567572, -0.07324324324324329, -0.07581081081081086, -0.07837837837837842, -0.080945945945946, -0.08351351351351356, -0.08608108108108113, -0.0886486486486487, -0.09121621621621627, -0.09378378378378384, -0.09635135135135141, -0.09891891891891898, -0.10148648648648655, -0.10405405405405412, -0.10662162162162168, -0.10918918918918925, -0.11175675675675682, -0.11432432432432439, -0.11689189189189196, -0.11945945945945953, -0.1220270270270271, -0.12459459459459467, -0.12716216216216222, -0.1297297297297298, -0.13229729729729736, -0.13486486486486493, -0.1374324324324325, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.14000000000000007, -0.13227272727272735, -0.12454545454545463, -0.1168181818181819, -0.10909090909090918, -0.10136363636363646, -0.09363636363636374, -0.08590909090909102, -0.0781818181818183, -0.07045454545454558, -0.06272727272727285, -0.055000000000000125, -0.0472727272727274, -0.03954545454545467, -0.03181818181818194, -0.02409090909090921, -0.016363636363636483, -0.008636363636363756, -0.0009090909090910294, 0.006818181818181697, 0.014545454545454424, 0.022272727272727152, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.02999999999999988, 0.026938775510203964, 0.023877551020408047, 0.02081632653061213, 0.017755102040816213, 0.014693877551020296, 0.01163265306122438, 0.008571428571428463, 0.005510204081632545, 0.002448979591836627, -0.0006122448979592908, -0.0036734693877552085, -0.006734693877551126, -0.009795918367347044, -0.012857142857142963, -0.01591836734693888, -0.018979591836734797, -0.022040816326530713, -0.02510204081632663, -0.028163265306122547, -0.031224489795918464, -0.034285714285714385, -0.037346938775510305, -0.040408163265306225, -0.043469387755102146, -0.046530612244898066, -0.049591836734693986, -0.05265306122448991, -0.05571428571428583, -0.05877551020408175, -0.06183673469387767, -0.06489795918367358, -0.0679591836734695, -0.07102040816326541, -0.07408163265306132, -0.07714285714285724, -0.08020408163265315, -0.08326530612244906, -0.08632653061224498, -0.08938775510204089, -0.0924489795918368, -0.09551020408163272, -0.09857142857142863, -0.10163265306122454, -0.10469387755102046, -0.10775510204081637, -0.11081632653061228, -0.1138775510204082, -0.11693877551020411, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.12000000000000002, -0.11187500000000003, -0.10375000000000004, -0.09562500000000004, -0.08750000000000005, -0.07937500000000006, -0.07125000000000006, -0.06312500000000007, -0.05500000000000008, -0.04687500000000008, -0.03875000000000009, -0.030625000000000093, -0.022500000000000096, -0.0143750000000001, -0.006250000000000103, 0.0018749999999998941, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.009999999999999891, 0.005925925925925818, 0.0018518518518517452, -0.0022222222222223276, -0.0062962962962964004, -0.010370370370370474, -0.014444444444444548, -0.01851851851851862, -0.022592592592592695, -0.02666666666666677, -0.030740740740740843, -0.034814814814814916, -0.03888888888888899, -0.04296296296296306, -0.04703703703703713, -0.0511111111111112, -0.05518518518518527, -0.05925925925925934, -0.06333333333333341, -0.06740740740740749, -0.07148148148148156, -0.07555555555555564, -0.07962962962962972, -0.0837037037037038, -0.08777777777777787, -0.09185185185185195, -0.09592592592592603, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.1000000000000001, -0.09250000000000011, -0.08500000000000012, -0.07750000000000012, -0.07000000000000013, -0.06250000000000014, -0.05500000000000014, -0.04750000000000014, -0.04000000000000014, -0.03250000000000014, -0.025000000000000144, -0.017500000000000147, -0.010000000000000151, -0.010000000000000151, -0.010000000000000151, -0.010000000000000151, -0.010000000000000151, -0.01350000000000015, -0.01700000000000015, -0.02050000000000015, -0.02400000000000015, -0.02750000000000015, -0.03100000000000015, -0.03450000000000015, -0.038000000000000145, -0.04150000000000014, -0.04500000000000014, -0.04850000000000013, -0.05200000000000013, -0.055500000000000126, -0.05900000000000012, -0.06250000000000012, -0.06600000000000013, -0.06950000000000013, -0.07300000000000013, -0.07650000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.08000000000000014, -0.06333333333333348, -0.046666666666666815, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.030000000000000155, -0.03600000000000015, -0.04200000000000014, -0.04800000000000013, -0.054000000000000124, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116, -0.060000000000000116]
obj_y = [0.75, 0.7428571428571429, 0.7357142857142858, 0.7285714285714286, 0.7214285714285715, 0.7142857142857144, 0.7071428571428573, 0.7000000000000002, 0.6928571428571431, 0.6857142857142859, 0.6785714285714288, 0.6714285714285717, 0.6642857142857146, 0.6571428571428575, 0.6500000000000004, 0.6428571428571432, 0.6357142857142861, 0.628571428571429, 0.6214285714285719, 0.6142857142857148, 0.6071428571428577, 0.6000000000000005, 0.5928571428571434, 0.5857142857142863, 0.5785714285714292, 0.5714285714285721, 0.564285714285715, 0.5571428571428578, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.5500000000000007, 0.553272727272728, 0.5565454545454553, 0.5598181818181827, 0.56309090909091, 0.5663636363636373, 0.5696363636363646, 0.5729090909090919, 0.5761818181818192, 0.5794545454545466, 0.5827272727272739, 0.5860000000000012, 0.5892727272727285, 0.5925454545454558, 0.5958181818181831, 0.5990909090909105, 0.6023636363636378, 0.6056363636363651, 0.6089090909090924, 0.6121818181818197, 0.615454545454547, 0.6187272727272743, 0.6220000000000017, 0.625272727272729, 0.6285454545454563, 0.6318181818181836, 0.6350909090909109, 0.6383636363636382, 0.6416363636363656, 0.6449090909090929, 0.6481818181818202, 0.6514545454545475, 0.6547272727272748, 0.6580000000000021, 0.6612727272727295, 0.6645454545454568, 0.6678181818181841, 0.6710909090909114, 0.6743636363636387, 0.677636363636366, 0.6809090909090934, 0.6841818181818207, 0.687454545454548, 0.6907272727272753, 0.6940000000000026, 0.6972727272727299, 0.7005454545454572, 0.7038181818181846, 0.7070909090909119, 0.7103636363636392, 0.7136363636363665, 0.7169090909090938, 0.7201818181818211, 0.7234545454545485, 0.7267272727272758, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7300000000000031, 0.7240740740740772, 0.7181481481481513, 0.7122222222222254, 0.7062962962962995, 0.7003703703703736, 0.6944444444444478, 0.6885185185185219, 0.682592592592596, 0.6766666666666701, 0.6707407407407442, 0.6648148148148183, 0.6588888888888924, 0.6529629629629665, 0.6470370370370406, 0.6411111111111147, 0.6351851851851888, 0.629259259259263, 0.6233333333333371, 0.6174074074074112, 0.6114814814814853, 0.6055555555555594, 0.5996296296296335, 0.5937037037037076, 0.5877777777777817, 0.5818518518518558, 0.57592592592593, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.5700000000000041, 0.573888888888893, 0.5777777777777819, 0.5816666666666709, 0.5855555555555598, 0.5894444444444488, 0.5933333333333377, 0.5972222222222267, 0.6011111111111156, 0.6050000000000045, 0.6088888888888935, 0.6127777777777824, 0.6166666666666714, 0.6205555555555603, 0.6244444444444492, 0.6283333333333382, 0.6322222222222271, 0.6361111111111161, 0.640000000000005, 0.643888888888894, 0.6477777777777829, 0.6516666666666718, 0.6555555555555608, 0.6594444444444497, 0.6633333333333387, 0.6672222222222276, 0.6711111111111165, 0.6750000000000055, 0.6788888888888944, 0.6827777777777834, 0.6866666666666723, 0.6905555555555613, 0.6944444444444502, 0.6983333333333391, 0.7022222222222281, 0.706111111111117, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.710000000000006, 0.7029411764705942, 0.6958823529411824, 0.6888235294117706, 0.6817647058823588, 0.674705882352947, 0.6676470588235353, 0.6605882352941235, 0.6535294117647117, 0.6464705882352999, 0.6394117647058881, 0.6323529411764763, 0.6252941176470646, 0.6182352941176528, 0.611176470588241, 0.6041176470588292, 0.5970588235294174, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5900000000000056, 0.5971428571428627, 0.6042857142857199, 0.611428571428577, 0.6185714285714341, 0.6257142857142912, 0.6328571428571483, 0.6400000000000055, 0.6471428571428626, 0.6542857142857197, 0.6614285714285768, 0.6685714285714339, 0.675714285714291, 0.6828571428571482, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6900000000000053, 0.6700000000000053, 0.6500000000000052, 0.6300000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6100000000000052, 0.6140000000000052, 0.6180000000000052, 0.6220000000000052, 0.6260000000000052, 0.6300000000000052, 0.6340000000000052, 0.6380000000000052, 0.6420000000000052, 0.6460000000000052, 0.6500000000000052, 0.6540000000000052, 0.6580000000000052, 0.6620000000000053, 0.6660000000000053, 0.6700000000000053, 0.6700000000000053, 0.6700000000000053, 0.6700000000000053, 0.666666666666672, 0.6633333333333387, 0.6600000000000054, 0.6566666666666721, 0.6533333333333388, 0.6500000000000055, 0.6466666666666722, 0.6433333333333389, 0.6400000000000056, 0.6366666666666723, 0.633333333333339, 0.6300000000000057, 0.6300000000000057, 0.6300000000000057, 0.6300000000000057, 0.6300000000000057, 0.6300000000000057, 0.6309090909090965, 0.6318181818181874, 0.6327272727272782, 0.6336363636363691, 0.63454545454546, 0.6354545454545508, 0.6363636363636417, 0.6372727272727325, 0.6381818181818234, 0.6390909090909143, 0.6400000000000051, 0.640909090909096, 0.6418181818181868, 0.6427272727272777, 0.6436363636363686, 0.6445454545454594, 0.6454545454545503, 0.6463636363636411, 0.647272727272732, 0.6481818181818229, 0.6490909090909137, 0.6500000000000046]

obj_x = obj_x[:455]
obj_y = obj_y[:455]

initial_static_x = [0.03202702702702702, -0.05783783783783788, -0.14000000000000007, -0.14000000000000007, -0.0009090909090910294, 0.017755102040816213, -0.08938775510204089, -0.12000000000000002, 0.009999999999999891, -0.09592592592592603, -0.02400000000000015, -0.030000000000000155, -0.060000000000000116]
initial_static_y = [0.5500000000000007, 0.5500000000000007, 0.5598181818181827, 0.6743636363636387, 0.7300000000000031, 0.5700000000000041, 0.5700000000000041, 0.6672222222222276, 0.6535294117647117, 0.5900000000000056, 0.6100000000000052, 0.666666666666672, 0.647272727272732]

grasp_static_x, grasp_static_y = [], []
for i in range(len(obj_x)):
    if i % 35 == 34:
        grasp_static_x.append(obj_x[i])
        grasp_static_y.append(obj_y[i])

grasp_static_x.append(np.random.uniform(-0.2, 0.1))
grasp_static_x.append(np.random.uniform(-0.2, 0.1))
grasp_static_x.append(np.random.uniform(-0.2, 0.1))
grasp_static_y.append(np.random.uniform(0.5, 0.8))
grasp_static_y.append(np.random.uniform(0.5, 0.8))
grasp_static_y.append(np.random.uniform(0.5, 0.8))


print(len(grasp_static_x))


class MetaWorldLineEnv(gym.Env):
    metadata = {"render.modes": ["rgb_array"], "video.frames_per_second": 10}

    def __init__(self, task_name, device="cuda:0", 
                 use_point_crop=True,
                 num_points=1024,
                 retarget_low=10, retarget_high=80, max_retargets=2, sampling_type='uniform', velocity=0.0, velocity_camera=0.0, velocity_obj=0.0
                 ):
        super(MetaWorldLineEnv, self).__init__()

        if '-v2' not in task_name:
            task_name = task_name + '-v2-goal-observable'

        self.task_name = task_name

        self.env = metaworld.envs.ALL_V2_ENVIRONMENTS_GOAL_OBSERVABLE[task_name]()
        # self.env.action_scale = 0.02 / 2
        # print(type(self.env), vars(self.env))
        # exit(0)
        self.env._freeze_rand_vec = False

        # https://arxiv.org/abs/2212.05698
        # self.env.sim.model.cam_pos[2] = [0.75, 0.015, 0.7]
        self.env.sim.model.cam_pos[2] = [0.6, 0.295, 0.8]
        

        self.env.sim.model.vis.map.znear = 0.1
        self.env.sim.model.vis.map.zfar = 1.5
        
        self.device_id = int(device.split(":")[-1])
        
        self.image_size = 128
        
        self.pc_generator = PointCloudGenerator(sim=self.env.sim, cam_names=['corner2'], img_size=self.image_size)
        self.use_point_crop = use_point_crop
        cprint("[MetaWorldEnv] use_point_crop: {}".format(self.use_point_crop), "cyan")
        self.num_points = num_points # 512
        
        x_angle = 61.4
        y_angle = -7
        self.pc_transform = np.array([
            [1, 0, 0],
            [0, np.cos(np.deg2rad(x_angle)), np.sin(np.deg2rad(x_angle))],
            [0, -np.sin(np.deg2rad(x_angle)), np.cos(np.deg2rad(x_angle))]
        ]) @ np.array([
            [np.cos(np.deg2rad(y_angle)), 0, np.sin(np.deg2rad(y_angle))],
            [0, 1, 0],
            [-np.sin(np.deg2rad(y_angle)), 0, np.cos(np.deg2rad(y_angle))]
        ])
        
        self.pc_scale = np.array([1, 1, 1])
        self.pc_offset = np.array([0, 0, 0])
        if task_name in TASK_BOUDNS:
            x_min, y_min, z_min, x_max, y_max, z_max = TASK_BOUDNS[task_name]
        else:
            x_min, y_min, z_min, x_max, y_max, z_max = TASK_BOUDNS['default']
        self.min_bound = [x_min, y_min, z_min]
        self.max_bound = [x_max, y_max, z_max]
        
    
        self.episode_length = self._max_episode_steps = 200
        self.action_space = self.env.action_space
        self.obs_sensor_dim = self.get_robot_state().shape[0]

        self.reset_num = 0
        self.success_reward_step = 0
        self.all_trajectory_step = 0

        self.retarget_high = retarget_high
        self.retarget_low = retarget_low
        print(self.retarget_high, self.retarget_low)
        self.retargeted = False
        self.already_change = False

        self.max_retargets = max_retargets
        self.sampling_type = sampling_type

        self.reset_obj_num = 0 #3
        self.reset_obj_cnt = 0
        self.grasp_cnt = 0
        self.retarget_step_list = []

        self.velocity = velocity
        self.velocity_camera = velocity_camera
        self.velocity_obj = velocity_obj

        v = np.random.beta(a=2, b=5, size=1)[0]

        self.move_step = 0

        self.trajectory_cnt = -1

        self.v = v * self.velocity
        # self.v = 0
        self.d = np.hstack([np.random.uniform(-1, 1, (1, 2)), np.zeros((1, 1))])

        if self.velocity:
            self.v_theta_camera = self.v / self.velocity * self.velocity_camera / 180 * np.pi * np.random.choice([-1,1])
        elif self.velocity_camera:
            self.v_theta_camera = np.random.beta(a=2, b=5, size=1)[0] * self.velocity_camera / 180 * np.pi * np.random.choice([-1,1])
        else:
            self.v_theta_camera = 0

        self.reset_target = np.random.randint(0, 20)

        self.v_obj = v * self.velocity_obj


        
    
        self.observation_space = spaces.Dict({
            'image': spaces.Box(
                low=0,
                high=255,
                shape=(3, self.image_size, self.image_size),
                dtype=np.float32
            ),
            'depth': spaces.Box(
                low=0,
                high=255,
                shape=(self.image_size, self.image_size),
                dtype=np.float32
            ),
            'agent_pos': spaces.Box(
                low=-np.inf,
                high=np.inf,
                shape=(self.obs_sensor_dim,),
                dtype=np.float32
            ),
            'point_cloud': spaces.Box(
                low=-np.inf,
                high=np.inf,
                shape=(self.num_points, 3),
                dtype=np.float32
            ),
            'full_state': spaces.Box(
                low=-np.inf,
                high=np.inf,
                shape=(20, ),
                dtype=np.float32
            ),
        })

    def get_robot_state(self):
        eef_pos = self.env.get_endeff_pos()
        finger_right, finger_left = (
            self.env._get_site_pos('rightEndEffector'),
            self.env._get_site_pos('leftEndEffector')
        )
        return np.concatenate([eef_pos, finger_right, finger_left])

    def get_rgb(self):
        # cam names: ('topview', 'corner', 'corner2', 'corner3', 'behindGripper', 'gripperPOV')
        img = self.env.sim.render(width=self.image_size, height=self.image_size, camera_name="corner2", device_id=self.device_id)
        return img

    def render_high_res(self, resolution=1024):
        img = self.env.sim.render(width=resolution, height=resolution, camera_name="corner2", device_id=self.device_id)
        return img
    

    def get_point_cloud(self, use_rgb=True):
        point_cloud, depth = self.pc_generator.generateCroppedPointCloud(device_id=self.device_id) # raw point cloud, Nx3
        
        
        if not use_rgb:
            point_cloud = point_cloud[..., :3]
        
        
        if self.pc_transform is not None:
            point_cloud[:, :3] = point_cloud[:, :3] @ self.pc_transform.T
        if self.pc_scale is not None:
            point_cloud[:, :3] = point_cloud[:, :3] * self.pc_scale
        
        if self.pc_offset is not None:    
            point_cloud[:, :3] = point_cloud[:, :3] + self.pc_offset
        
        if self.use_point_crop:
            if self.min_bound is not None:
                mask = np.all(point_cloud[:, :3] > self.min_bound, axis=1)
                point_cloud = point_cloud[mask]
            if self.max_bound is not None:
                mask = np.all(point_cloud[:, :3] < self.max_bound, axis=1)
                point_cloud = point_cloud[mask]

        point_cloud = point_cloud_sampling(point_cloud, self.num_points, 'fps')
        
        depth = depth[::-1]
        
        return point_cloud, depth
        

    def get_visual_obs(self):
        obs_pixels = self.get_rgb()
        robot_state = self.get_robot_state()
        point_cloud, depth = self.get_point_cloud()
        
        if obs_pixels.shape[0] != 3:
            obs_pixels = obs_pixels.transpose(2, 0, 1)

        obs_dict = {
            'image': obs_pixels,
            'depth': depth,
            'agent_pos': robot_state,
            'point_cloud': point_cloud,
        }
        return obs_dict

    def reset_sampling(self, sampling='uniform', low=0, high=0):
        lower, upper = low, high  # 采样区间
        n_samples = 1       # 采样数量

        if sampling == 'uniform':
            sample = np.random.uniform(low=lower, high=upper, size=n_samples)
        elif sampling == 'beta':
            beta_a, beta_b = 2, 5  # 形状参数，a,b>0
            sample = lower + (upper - lower) * np.random.beta(beta_a, beta_b, n_samples)
        elif sampling == 'gaussian':
            gauss_mu = (lower + upper) / 2    # 均值设为区间中点
            gauss_sigma = 12                  # 标准差控制数据集中程度
            a_trunc = (lower - gauss_mu) / gauss_sigma
            b_trunc = (upper - gauss_mu) / gauss_sigma
            sample = truncnorm.rvs(
                a_trunc, b_trunc, 
                loc=gauss_mu, 
                scale=gauss_sigma, 
                size=n_samples
            )
        elif sampling == 'const':
            sample = [50]

        return round(sample[0])



    def step(self, action: np.array, collect=False, move_collect=False):

        # if self.cur_step == 0:
        #     self.env.set_new_obj(state=np.array([initial_static_x[self.trajectory_cnt], initial_static_y[self.trajectory_cnt], 0.02]))
        #     self.move_step += 1

        if self.cur_step == 0:
            self.env.set_new_obj(state=np.array([grasp_static_x[self.trajectory_cnt], grasp_static_y[self.trajectory_cnt], 0.02]))
            self.move_step += 1


        raw_state, reward, done, env_info = self.env.step(action)
        self.cur_step += 1  # 更新总步数计数器

        env_info['set_obj'] = False


        # if self.cur_step < 35 and move_collect:

        #     if self.env.move_object:
        #         self.env.set_new_obj(state=np.array([obj_x[self.move_step], obj_y[self.move_step], 0.02])) #self.d_tmp

        #         self.move_step += 1




     

        # ===================== 观测数据生成 =====================
        obs_pixels = self.get_rgb()
        robot_state = self.get_robot_state()
        point_cloud, depth = self.get_point_cloud()
        
        if obs_pixels.shape[0] != 3:  # make channel first
            obs_pixels = obs_pixels.transpose(2, 0, 1)

        obs_dict = {
            'image': obs_pixels,
            'depth': depth,
            'agent_pos': robot_state,
            'point_cloud': point_cloud,
            'full_state': raw_state,
        }

        # ===================== 终止条件判断 =====================
        # 基础终止条件：达到最大步数
        done = done or self.cur_step >= self.episode_length

        if 'drawer' in self.task_name:
            if env_info['success'] and collect and self.remaining_retargets==0 and (not self.waiting_for_retarget) and (self.reset_obj_cnt == self.reset_obj_num or not move_collect):
                self.success_reward_step += 1

            if self.success_reward_step > 9:
                done = True
        
        if reward == 10 and collect and self.remaining_retargets==0 and (not self.waiting_for_retarget) and (self.reset_obj_cnt == self.reset_obj_num or not move_collect):
            self.success_reward_step += 1

            if self.success_reward_step > 9:
                done = True

        return obs_dict, reward, done, env_info


    def reset(self):
        self.env.reset()
        print('3285674989tq0')
        self.env.reset_model(set_xyz=True)
        # self.env.reset_model()
        raw_obs = self.env.reset()

        self.trajectory_cnt += 1
        
        # 重置所有状态变量
        self.cur_step = 0
        self.remaining_retargets = self.max_retargets  # 从超参数初始化
        self.target_step = None
        self.waiting_for_retarget = False
        self.success_counter = 0
        self.success_reward_step = 0
        self.reset_obj_step = self.reset_sampling(self.sampling_type, 50, 70)
        self.retarget_step_list = []
        # self.reset_obj_step = 50
        self.reset_obj_cnt = 0
        self.grasp_cnt = 0

        v = np.random.beta(a=2, b=5, size=1)[0]

        self.v = v * self.velocity
        self.d = np.hstack([np.random.uniform(-1, 1, (1, 2)), np.zeros((1, 1))])

        self.v_obj = v * self.velocity_obj
        self.d_obj = np.hstack([np.random.uniform(-1, 1, (1, 2)), np.zeros((1, 1))])

        self.d_tmp = np.array([[1,1,0]])

        if self.velocity:
            self.v_theta_camera = self.v / self.velocity * self.velocity_camera / 180 * np.pi * np.random.choice([-1,1])
        elif self.velocity_camera:
            self.v_theta_camera = np.random.beta(a=2, b=5, size=1)[0] * self.velocity_camera / 180 * np.pi * np.random.choice([-1,1])
        else:
            self.v_theta_camera = 0

        self.v_obj = v * self.velocity_obj

        print(self.reset_obj_step)

        # 观测数据生成（保持原有逻辑）
        obs_pixels = self.get_rgb()
        robot_state = self.get_robot_state()
        point_cloud, depth = self.get_point_cloud()
        
        if obs_pixels.shape[0] != 3:
            obs_pixels = obs_pixels.transpose(2, 0, 1)

        obs_dict = {
            'image': obs_pixels,
            'depth': depth,
            'agent_pos': robot_state,
            'point_cloud': point_cloud,
            'full_state': raw_obs,
        }


        return obs_dict

    def seed(self, seed=None):
        pass

    def set_seed(self, seed=None):
        pass

    def render(self, mode='rgb_array'):
        img = self.get_rgb()
        return img

    def close(self):
        pass

